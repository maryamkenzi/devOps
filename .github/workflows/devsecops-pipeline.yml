name: Akaunting DevSecOps Pipeline

on:
  push:
    branches: [ main ]

jobs:
  ci:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        extensions: mbstring, pdo_mysql, intl, gd, zip

    - name: Install dependencies
      run: composer install --no-interaction --prefer-dist

    - name: PHP syntax check (Akaunting)
      run: |
        set +e
        for dir in app config routes modules database; do
          if [ -d "$dir" ]; then
            find "$dir" -name "*.php" -exec php -l {} \;
          fi
        done
        set -e

    - name: Run tests (optional)
      run: |
        if [ -f vendor/bin/phpunit ]; then
          vendor/bin/phpunit || true
        else
          echo "No PHPUnit found, skipping tests"
        fi

    - name: Build Docker image
      run: docker build -t akaunting:latest .

    - name: Security scan (Trivy)
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: akaunting:latest
        exit-code: 0
