name: DevSecOps Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * 0'  # Weekly security scan

jobs:
  # Build and Test
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        extensions: mbstring, xml, ctype, iconv, intl, gd, zip, pdo_mysql

    - name: Install dependencies
      run: |
        composer install --no-interaction --prefer-dist --no-progress

    - name: PHP Syntax Check
      run: |
        find app routes bootstrap config -name "*.php" -type f -exec php -l {} \; | grep -v "No syntax errors"

    - name: Run PHPUnit Tests
      run: |
        if [ -f "vendor/bin/phpunit" ]; then
          vendor/bin/phpunit --testdox
        else
          echo "PHPUnit not found, skipping tests"
        fi

    - name: Build Docker Image
      run: |
        docker build -t akaunting-app:latest -t akaunting-app:${{ github.sha }} .

  # Security Scanning
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Dependency Vulnerability Check
      run: |
        composer audit --format=plain --no-interaction

    - name: Secret Detection
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event.repository.default_branch }}
        head: HEAD

    - name: Container Security Scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'akaunting-app:latest'
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH'

    - name: Upload Security Report
      uses: actions/upload-artifact@v3
      with:
        name: security-report
        path: trivy-results.sarif
        retention-days: 7

  # Quality Checks
  quality-check:
    name: Quality Check
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'

    - name: PHP Code Sniffer
      run: |
        composer require --dev squizlabs/php_codesniffer
        vendor/bin/phpcs --standard=PSR12 app/ --report=summary

    - name: PHPStan Static Analysis
      run: |
        composer require --dev phpstan/phpstan
        vendor/bin/phpstan analyse app/ --level=5 --no-progress

  # Deployment Preparation
  deployment-prep:
    name: Deployment Preparation
    runs-on: ubuntu-latest
    needs: [security-scan, quality-check]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create Deployment Package
      run: |
        mkdir -p deployment-package
        cp -r app bootstrap config database public resources routes storage deployment-package/
        cp .env.example deployment-package/.env
        cp artisan deployment-package/
        cp composer.json deployment-package/
        cp composer.lock deployment-package/
        
        cat > deployment-package/.env.production << EOF
        APP_NAME="Akaunting"
        APP_ENV=production
        APP_DEBUG=false
        APP_URL=\${APP_URL}
        
        DB_CONNECTION=mysql
        DB_HOST=\${DB_HOST}
        DB_PORT=3306
        DB_DATABASE=\${DB_DATABASE}
        DB_USERNAME=\${DB_USERNAME}
        DB_PASSWORD=\${DB_PASSWORD}
        EOF
        
        zip -r akaunting-deployment.zip deployment-package/

    - name: Upload Deployment Package
      uses: actions/upload-artifact@v3
      with:
        name: akaunting-deployment-package
        path: akaunting-deployment.zip
        retention-days: 30