name: CI Pipeline - Akaunting

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # Job 1: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬ÙˆØ¯Ø© ÙˆØ§Ù„Ø¨Ù†Ø§Ø¡
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„ÙƒÙˆØ¯
      uses: actions/checkout@v4

    - name: ğŸ˜ Ø¥Ø¹Ø¯Ø§Ø¯ PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        extensions: mbstring, xml, ctype, iconv, intl, pdo_sqlite, gd, zip

    - name: ğŸ“¦ ØªØ«Ø¨ÙŠØª Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯Ø§Øª
      run: |
        composer install --no-progress --prefer-dist
        npm install  # Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ frontend

    - name: ğŸ” ÙØ­Øµ Ø¨Ù†Ø§Ø¡ PHP
      run: |
        php -l app/Http/Controllers/*
        php -l app/Models/*
        echo "âœ… Ø¨Ù†Ø§Ø¡ PHP Ø³Ù„ÙŠÙ…"

    - name: ğŸ§ª ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
      run: |
        vendor/bin/phpunit --testdox
        echo "âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù†Ø§Ø¬Ø­Ø©"

    - name: ğŸ³ Ø¨Ù†Ø§Ø¡ Docker Image
      run: |
        docker build -t akaunting-app:latest .
        echo "âœ… ØªÙ… Ø¨Ù†Ø§Ø¡ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­"

    - name: ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬
      if: always()
      run: |
        echo "ğŸ“ˆ ØªÙ‚Ø±ÙŠØ± CI Pipeline"
        echo "âœ… Ø§Ù„Ø¨Ù†Ø§Ø¡: Ù…ÙƒØªÙ…Ù„"
        echo "âœ… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª: Ù…ÙƒØªÙ…Ù„Ø©"
        echo "âœ… Docker: Ù…Ø¨Ù†ÙŠØ©"
        echo "ğŸ‰ Pipeline Ù†Ø§Ø¬Ø­!"

  # Job 2: Ø§Ù„ÙØ­ÙˆØµØ§Øª Ø§Ù„Ø£Ù…Ù†ÙŠØ© (DevSecOps)
  security-checks:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„ÙƒÙˆØ¯
      uses: actions/checkout@v4

    - name: ğŸ›¡ï¸ ÙØ­Øµ Ø§Ù„Ø«ØºØ±Ø§Øª ÙÙŠ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª
      run: |
        composer audit --format=plain
        echo "âœ… ÙØ­Øµ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯Ø§Øª Ù…ÙƒØªÙ…Ù„"

    - name: ğŸ” Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø£Ø³Ø±Ø§Ø± ÙÙŠ Ø§Ù„ÙƒÙˆØ¯
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event.repository.default_branch }}
        head: HEAD

    - name: ğŸ“ ÙØ­Øµ Ù…Ù„ÙØ§Øª Ø§Ù„ØªÙƒÙˆÙŠÙ†
      run: |
        echo "ğŸ” ÙØ­Øµ Ù…Ù„ÙØ§Øª Ø§Ù„ØªÙƒÙˆÙŠÙ†..."
        # ÙØ­Øµ .env.example
        if [ -f ".env.example" ]; then
          echo "âœ… Ù…Ù„Ù .env.example Ù…ÙˆØ¬ÙˆØ¯"
        fi
        
        # ÙØ­Øµ Ù…Ù„ÙØ§Øª Docker
        if [ -f "Dockerfile" ]; then
          echo "âœ… Dockerfile Ù…ÙˆØ¬ÙˆØ¯"
          grep -i "root" Dockerfile || echo "âœ… Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ´ØºÙŠÙ„ ÙƒÙ€ root"
        fi

    - name: ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù…Ù†
      run: |
        echo "ğŸ›¡ï¸ ØªÙ‚Ø±ÙŠØ± DevSecOps"
        echo "âœ… Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯Ø§Øª: Ø¢Ù…Ù†Ø©"
        echo "âœ… Ø§Ù„Ø£Ø³Ø±Ø§Ø±: ØºÙŠØ± Ù…ÙƒØªØ´ÙØ©"
        echo "âœ… Ø§Ù„ØªÙƒÙˆÙŠÙ†: Ø³Ù„ÙŠÙ…"

  # Job 3: Ø§Ù„Ù†Ø´Ø± (Ø¨Ø¯ÙˆÙ† AWS - Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·)
  deployment-preview:
    runs-on: ubuntu-latest
    needs: [build-and-test, security-checks]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„ÙƒÙˆØ¯
      uses: actions/checkout@v4

    - name: ğŸš€ ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù†Ø´Ø± (Ø¨Ø¯ÙˆÙ† ØªÙ†ÙÙŠØ°)
      run: |
        echo "ğŸš€ Ø¬Ø§Ù‡Ø² Ù„Ù„Ù†Ø´Ø±!"
        echo "ğŸ“¦ Ø§Ù„Ø¥ØµØ¯Ø§Ø±: $(date +%Y%m%d-%H%M%S)"
        echo "ğŸ”— Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ´ØºÙŠÙ„ Ù…Ø­Ù„ÙŠØ§Ù‹"
        echo ""
        echo "ğŸ“‹ Ø®Ø·ÙˆØ§Øª Ø§Ù„Ù†Ø´Ø± Ø§Ù„ÙŠØ¯ÙˆÙŠ:"
        echo "1. docker build -t akaunting-app ."
        echo "2. docker run -p 8000:80 akaunting-app"
        echo "3. Ø§ÙØªØ­ http://localhost:8000"
        echo ""
        echo "ğŸ’¡ Ù…Ù„Ø§Ø­Ø¸Ø©: AWS Ùˆ Terraform Ø¬Ø§Ù‡Ø²Ø§Ù† Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù„Ø§Ø­Ù‚Ø§Ù‹"

    - name: ğŸ¯ Ø¥Ù†Ø´Ø§Ø¡ Artifact Ù„Ù„ØªØ­Ù…ÙŠÙ„
      run: |
        mkdir -p deployment
        cp -r app bootstrap config database public resources routes storage vendor deployment/
        cp .env.example deployment/.env
        cp Dockerfile deployment/
        cp docker-compose.yml deployment/
        
        echo "APP_NAME=Akaunting" >> deployment/.env
        echo "APP_ENV=production" >> deployment/.env
        echo "APP_DEBUG=false" >> deployment/.env
        echo "APP_URL=http://localhost" >> deployment/.env
        
        zip -r akaunting-deployment.zip deployment/

    - name: ğŸ“¤ Ø±ÙØ¹ Artifact
      uses: actions/upload-artifact@v3
      with:
        name: akaunting-deployment
        path: akaunting-deployment.zip