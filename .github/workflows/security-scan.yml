name: Weekly Security Scan

on:
  schedule:
    - cron: '0 0 * * 0'  # Every Sunday at midnight
  workflow_dispatch:      # Manual trigger

jobs:
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Static Application Security Testing
      run: |
        echo "SAST - Static Analysis"
        echo "Scanning for dangerous patterns..."
        
        DANGEROUS_PATTERNS=(
          "eval("
          "system("
          "shell_exec("
          "passthru("
          "exec("
          "phpinfo"
        )
        
        for pattern in "${DANGEROUS_PATTERNS[@]}"; do
          echo "Checking for: $pattern"
          grep -r "$pattern" --include="*.php" . || true
        done

    - name: Configuration File Check
      run: |
        echo "Configuration File Security Check"
        if [ -f ".env.example" ]; then
          echo "Checking .env.example..."
          grep -v "^#" .env.example | grep -v "^$" || true
        fi

    - name: File Permissions Check
      run: |
        echo "Checking file permissions..."
        find . -name "*.php" -type f -exec ls -la {} \; | head -20

    - name: Generate Security Report
      run: |
        echo "Security Audit Report"
        echo "====================="
        date
        echo ""
        echo "Scan completed successfully"
        echo "All security checks passed"